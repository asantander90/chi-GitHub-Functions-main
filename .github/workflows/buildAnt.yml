name: Build (Docker Ant)

on:
  workflow_call:
    inputs:
      java_version:
        description: 'Versión de Java del proyecto'
        required: true
        default: '11'
        type: string
      artifacts_pattern:
        description: 'Directorio o expresión regular que describe qué se desea almacenar como artefacto'
        required: true
        default: 'dist/*ear'
        type: string
    outputs:
      ear_file_name:
        description: "Nombre del artefacto compilado"
        value: ${{ jobs.build.outputs.artifact_name }}

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: openjdk:${{ inputs.java_version }}
      options: --user root

    outputs:
      artifact_name: ${{ steps.build.outputs.earName }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Verificar los archivos descargados dentro del contenedor
        run: |
          ls -lrt

      - name: Instalar Ant
        run: |
          apt-get update && apt-get install -y ant

      - name: Compilar con Ant
        id: build
        run: |
          ant -f HelloWorldAPP/build.xml
          EAR_NAME=$(basename $(find dist -name "*.ear" | head -n1))
          echo "earName=$EAR_NAME" >> $GITHUB_OUTPUT

      - name: Guardar archivo para job siguiente
        run: |
          mkdir -p ../artefacto
          cp dist/*.ear ../artefacto/

  upload:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Subir artefacto
        uses: actions/upload-artifact@v3
        with:
          name: ${{ needs.build.outputs.artifact_name }}
          path: ../artefacto/*.ear
